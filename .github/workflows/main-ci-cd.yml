name: CI/CD Pipeline Hijo website

on:
    push:
        branches: ["main", "**"]

jobs:
    # testing sebelum masuk ke branch main
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.2'

            - name: Install Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Directory Permissions
              run: chmod -R 777 storage bootstrap/cache

            - name: Execute Test
              run: vendor/bin/phpunit
    

    # image akan dipush ke docker hub romiwahyudi
    build-and-push: 
        needs: test
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Login to Docker hub
              uses: docker/login-action@v2
              with: 
                username: ${{secrets.DOCKER_USERNAME}}
                password: ${{secrets.DOCKER_PASSWORD}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                context: .
                push: true
                tags: ${{secrets.DOCKER_USERNAME}}/hijo-app:latest
            



